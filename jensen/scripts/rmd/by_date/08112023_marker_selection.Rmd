---
title: "RNAscope marker selection"
author: "Brian Gural"
date: "2023-08-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r load libs, message=FALSE, echo = T, warning=FALSE, results= 'hide', cache=FALSE, include=F}
# List libraries
libs <- c("Seurat", "ggplot2", "patchwork", "SeuratDisk","reshape2", "tidyverse",
          "SCpubr","shiny", "ggrepel", "gridExtra", "scCustomize", "httr", 
          "scales", "dplyr", "DeconvoBuddies", "readr", "SingleCellExperiment",
          "SummarizedExperiment", "Biobase", "ggmagnify", "stringr", "MuSiC",
          "ggforce", "DirichletReg", "readxl") # list libraries here
# Require all of them
lapply(libs, require, character.only = T)

# Also load in-house functions
source("jensen/scripts/functions/decon_all.R")
```


```{r load data, message=FALSE, echo = T, warning=FALSE, cache=FALSE, include=F}
# Script used to produce this can be found at jensen/scripts/rmd/by_date/07192023_1.rmd
sn <- LoadH5Seurat("jensen/data/processed/single_cell/merged_datasets/07192023/07192023_1.h5seurat")

jensen_bulk <- read.csv("jensen/results/deseq2_08032023/bulk_data", row.names = 1)

comps <- read.csv("jensen/results/deseq2_08032023/comp_data", row.names = 1)
colnames(comps)[3] <- "endothelial_cells"

```

## Including Plots


```{r DeconvoBuddies Find markers, fig.width = 7, fig.height= 8, echo=FALSE, message=FALSE, warning=FALSE, include = F}
# Update sn with annotations
cells <- sample(colnames(sn), 10000, replace = FALSE)
sn$ident <- Idents(sn)
seurat <- sn 
seurat$annots <- Idents(seurat)

# Subset Seurat object and convert to SummarizedExperiment
seurat <- seurat |>
  subset(cells = cells, features = rownames(seurat)[rownames(seurat) %in% rownames(jensen_bulk)])

sn.sce <- seurat |>
  as.SingleCellExperiment(assay = "RNA") |>
  as("SummarizedExperiment")

# Add gene names
rownames(sn.sce) <- rownames(seurat@assays$RNA@counts)

# Get markers based on expression ratios between clusters and 1vAll comparisons
ratios <- get_mean_ratio2(sn.sce, cellType_col = "ident")
fc <- findMarkers_1vAll(sn.sce, cellType_col = "ident", mod = "~origin")

# Subset markers based on rank_ratio and logFC
marker_genes <- ratios  |> 
  left_join(fc, by = c("gene", "cellType.target")) |>
  filter(gene %in% rownames(sn)) |>
  group_by(cellType.target) |>
  mutate(rank_ratio = row_number()) |>
  filter(rank_ratio <= 50) 

rm(seurat)
gc()
```

You can also embed plots, for example:

```{r Cluster Assignments, echo=FALSE,warning=FALSE, include=TRUE, fig.height = 50, fig.width = 16}
plotGene <- function(seurat, slot = "scale.data", gene, plot.title = T, plot.legend = T){
  
  seurat |>
    do_FeaturePlot(gene, reduction = "umap", slot = slot, 
                   legend.position = if(plot.legend == T){"bottom"}else{"none"}, 
                   legend.width = 2, legend.length = 25,  order = F) +
    theme(title = element_text(size = 22),
          legend.title = element_blank()) +
    labs(title = if(plot.title == T){paste0(gene, ", " , names(gene))}else{" "})
}

cm.markers <- marker_genes |>
                  group_by(cellType.target) |>
                  subset(cellType.target == "cardiomyocytes") |>
                  arrange(-std.logFC)|>
                  slice_head(n = 10)

genes.cm <- cm.markers$gene
names(genes.cm) <- c(cm.markers$anno_ratio)


fib.markers <- marker_genes |>
                  group_by(cellType.target) |>
                  subset(cellType.target == "fibroblasts") |>
                  arrange(-std.logFC)|>
                  slice_head(n = 10)
    

genes.fib <- fib.markers$gene
names(genes.fib) <- c(fib.markers$anno_ratio)

genes <- c(genes.cm, genes.fib)

# plot new
plots <- c()
plots[["cell"]] <- do_DimPlot(sn, reduction = "umap", label = T, repel = T, plot.title = "Cell clusters")  +  
  NoLegend() + theme(title = element_text(size = 22))
plots.exp <- lapply(names(genes), function(x){plotGene(seurat = sn, slot = "data", gene = genes[x], plot.legend = F)})


wrap_plots(plots.exp, 
           ncol = 2)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
